<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-28","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Litho" href="/opensearch.xml"><title data-react-helmet="true">Asynchronous Layout | Litho</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://fblitho.com/docs/asynchronous-layout/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Asynchronous Layout | Litho"><meta data-react-helmet="true" name="description" content="Immutability and Thread Safety"><meta data-react-helmet="true" property="og:description" content="Immutability and Thread Safety"><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fblitho.com/docs/asynchronous-layout/"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/asynchronous-layout/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/asynchronous-layout/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.500f1454.css">
<link rel="preload" href="/assets/js/runtime~main.29a8671b.js" as="script">
<link rel="preload" href="/assets/js/main.1aee5720.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="color:#091E42" role="banner"><div class="announcementBarContent_3EUC">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.facebook.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Litho</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro/motivation/">Docs</a><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a><a class="navbar__item navbar__link" href="/docs/tutorial/overview/">Tutorial</a><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_1lV3"><div class="docItemContainer_zt2Y"><article><header><h1 class="docTitle_1y8q">Asynchronous Layout</h1></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_31ik" id="immutability-and-thread-safety">Immutability and Thread Safety<a aria-hidden="true" class="hash-link" href="#immutability-and-thread-safety" title="Direct link to heading">â€‹</a></h2><p>Most issues with thread safety derive from concurrent reads and writes on mutable objects. This is how a classic example of this problem looks in Java:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  public class SomeExampleClass {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int mCounter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getThisOrThat() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (mCounter &gt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;this&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mCounter++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;that&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If multiple threads were to invoke <code>getThisOrThat</code> on a shared instance of <code>SomeExampleClass</code> that would be the most classic example of race condition. By the time the second thread entering the method tries to read <code>mCounter</code>, the first thread might be in the process of executing <code>mCounter++</code> and we wouldn&#x27;t be able to determine the value that the second thread would read from <code>mCounter</code>.
The problem in general is that in this code there is a mutable state (<code>mCounter</code>) and multiple threads trying to write and read it.
Race conditions are the most common problem when writing applications that try to distribute work on multiple threads.</p><p>This is exactly why traditionally, running UI code on multiple thread has always been extremely complex.
Android views are stateful and mutable. For example, a <code>TextView</code> must keep track of the current text that it&#x27;s displaying and at the same time exposes a <code>setText()</code> method that allows the developer to mutate the text.
This means that if the Android UI framework decided to offload things like layout calculation on a secondary thread, it would have to solve the problem of a user calling <code>setText()</code> from another thread and mutating the current text while
the layout computation is happening.</p><p>Let&#x27;s go back for a second to our sample code. We said that the main problem there was the mutable state <code>mCounter</code> accessed inside our <code>getThisOrThat()</code> method. Is there a way to write code that is functionally equivalent without having to rely on such mutable state?
Let&#x27;s try to imagine for a moment that no object can ever mutate its content after creation. If nothing can mutate, we can&#x27;t ever have races between threads trying to mutate and read the same state.
We can rewrite our sample code to look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static class Result {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final int mCounter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final String mValue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result(int counter, int value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mCounter = counter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mValue = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public class SomeExampleClass {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Result getThisOrThat(int counterValue) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (counterValue &gt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Result(counterValue, &quot;this&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Result(counterValue + 1, &quot;that&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Our method is now completely thread safe as it never modifies any internal state of <code>SomeExampleClass</code>. In this example, <code>getThisOrThat()</code> is what&#x27;s called a &#x27;pure function&#x27; as its results only depend on the inputs and it doesn&#x27;t have any side effect.</p><p>In Litho, we try to apply exactly the same concepts to layout computation. A <code>Component</code> is an immutable object that contains all the inputs for the layout function in form of <code>@Prop</code> and <code>@State</code> values. This also explains why we need <code>@Prop</code> and <code>@State</code> to be immutable. If they weren&#x27;t, we would lose the property of having layout as a &#x27;pure function&#x27;.</p><p>Immutability in Java usually comes at the cost of having to do many more allocations. Even in our simple example we are now allocating a <code>Result</code> object for every invocation of our function. Litho uses pooling and <a href="/docs/codegen/">code generation</a> to minimize object allocations for you automatically.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="sync-and-async-operations">Sync and Async Operations<a aria-hidden="true" class="hash-link" href="#sync-and-async-operations" title="Direct link to heading">â€‹</a></h2><p>Litho offers both synchronous and asynchronous APIs for layout computation. Both APIs are thread safe and can be invoked from any thread. The final layout will always represent the Component that was set last with calls to <code>setRoot()</code> or <code>setRootAsync()</code>.</p><p>Synchronous layout calculation ensures that immediately after calling <code>setRoot()</code> on a <a href="/javadoc/com/facebook/litho/ComponentTree.html" target="_blank" rel="noopener noreferrer">ComponentTree</a>, the result of the layout calculation is available to be mounted on a <a href="/javadoc/com/facebook/litho/LithoView.html" target="_blank" rel="noopener noreferrer">LithoView</a>.
The main disadvantage of this is that the computation happens on the caller thread, therefore calling <code>setRoot()</code> from the main thread is not advisable. On the other hand, there are situations in which you cannot wait for a background thread to compute a layout before showing something on screen, such as when the item you want to display is already in the viewport. In these cases, calling <code>setRoot()</code> synchronously is the best route.
Having synchronous operations also makes it very easy to integrate Litho with pre-existing threading models. If your application already has a complex and structured thread design you might want to fit the layout calculation into it without relying on Litho&#x27;s built-in threads.</p><p>Asynchronous layout calculation will use Litho&#x27;s Layout Thread to compute the Component layout. This means that the work gets enqueued immediately on a separate thread and the layout result will not be visible immediately on the calling thread. Asynchronous layout operations are used widely, for example, from the <code>RecyclerCollectionComponent</code>.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/litho/edit/master/website/../docs/asynchronous-layout.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#immutability-and-thread-safety" class="table-of-contents__link toc-highlight">Immutability and Thread Safety</a></li><li><a href="#sync-and-async-operations" class="table-of-contents__link toc-highlight">Sync and Async Operations</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started</a></li><li class="footer__item"><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/contributing/">How To Contribute</a></li><li class="footer__item"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Open Source Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/fblitho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Facebook, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.29a8671b.js"></script>
<script src="/assets/js/main.1aee5720.js"></script>
</body>
</html>