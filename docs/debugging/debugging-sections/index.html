<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-28","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Litho" href="/opensearch.xml"><title data-react-helmet="true">Debugging Sections | Litho</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://fblitho.com/docs/debugging/debugging-sections/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Debugging Sections | Litho"><meta data-react-helmet="true" name="description" content="Debugging Litho Sections Surfaces with the Flipper Sections Plugin"><meta data-react-helmet="true" property="og:description" content="Debugging Litho Sections Surfaces with the Flipper Sections Plugin"><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fblitho.com/docs/debugging/debugging-sections/"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/debugging/debugging-sections/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/debugging/debugging-sections/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.500f1454.css">
<link rel="preload" href="/assets/js/runtime~main.317d2bec.js" as="script">
<link rel="preload" href="/assets/js/main.ddc73d99.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="color:#091E42" role="banner"><div class="announcementBarContent_3EUC">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.facebook.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Litho</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro/motivation/">Docs</a><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a><a class="navbar__item navbar__link" href="/docs/tutorial/overview/">Tutorial</a><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What is Litho?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Main Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Building lists</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Animations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Visibility</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Accessibility</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Widgets</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Adopting Litho</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Codegen APIs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Tooling</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Debugging</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/debugging/debugging-tips/">Debugging Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/debugging/debugging-sections/">Debugging Sections</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Developer Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/performance/analysing-performance/">Analysing Performance</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_1lV3"><div class="docItemContainer_zt2Y"><article><header><h1 class="docTitle_1y8q">Debugging Sections</h1></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_31ik" id="debugging-litho-sections-surfaces-with-the-flipper-sections-plugin">Debugging Litho Sections Surfaces with the Flipper Sections Plugin<a aria-hidden="true" class="hash-link" href="#debugging-litho-sections-surfaces-with-the-flipper-sections-plugin" title="Direct link to heading">â€‹</a></h2><p>This page acts as a debugging guide that explains how to read the operations performed when an event occurs in a Sections surface. This will help debug common issues such as unwanted scrolling and items getting re-rendered incorrectly.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="sections-hierarchies">Sections Hierarchies<a aria-hidden="true" class="hash-link" href="#sections-hierarchies" title="Direct link to heading">â€‹</a></h3><p>In a Litho+Sections hierarchy, the common setup is to have a <code>RecyclerCollectionComponent</code> as the root of your <code>LithoView</code>. This component is the bridge with the Sections hierarchy. You&#x27;ll use this setup indirectly if you&#x27;re using <code>SectionsHelper</code>.</p><p>The <code>RecyclerCollectionComponent</code> wraps a <code>Recycler</code> component which mounts a <code>RecyclerView</code>. All sections surfaces are just APIs to make it easier to work with <code>RecyclerView</code> and <code>RecyclerView.Adapter</code>.</p><p>The adapter abstraction used in Sections is called a <code>RecyclerBinder</code>.
All adapter operations are dispatched to the <code>RecyclerBinder</code>, which will use the render information implemented by the user in the GroupSectionSpec to transform them into <code>LithoViews</code> hosting <code>ComponentTrees</code>.  The <code>LithoViews</code> represent the items inserted into the <code>RecyclerView.Adapter</code>.</p><p>Simply put, under the hood, a Sections hierarchy is represented by a <code>RecyclerView</code> with a single view type which is the <code>LithoView</code>. Each item in the list is its own <code>ComponentTree</code>.</p><p><img src="/assets/images/debugging-sections-hierarchies-034085e8d2ab236c8df7eb899fb30dcd.png"></p><h3 class="anchor anchorWithStickyNavbar_31ik" id="sections-terminology">Sections Terminology<a aria-hidden="true" class="hash-link" href="#sections-terminology" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_31ik" id="diffing">Diffing<a aria-hidden="true" class="hash-link" href="#diffing" title="Direct link to heading">â€‹</a></h4><p>Diffing means comparing the existing data on a Section with an updated list passed through props or state. You will accomplish this through special Section Spec types called <a href="/docs/sections/start/">DiffSectionSpecs</a>.</p><h4 class="anchor anchorWithStickyNavbar_31ik" id="changesets">Changesets<a aria-hidden="true" class="hash-link" href="#changesets" title="Direct link to heading">â€‹</a></h4><p>A <code>Changeset</code> is a list of operations that are dispatched to the <code>RecyclerView Adapter</code> to update the items in a list. A Changeset consists of the same type of operations supported by a <code>RecyclerView Adapter</code>, such as insert, remove and update.</p><p>Every time you recreate the Sections hierarchy by setting a new root or updating state, the framework calculates a new <code>Changeset</code> which will have the minimal list of operations that should be performed by the <code>RecyclerView Adapter</code> to reflect the data changes in the UI.</p><p>Without using Sections, itâ€™s the Developerâ€™s responsibility to calculate granular operations for efficient updates to send to the Adapter, but the Sections API handles all of that.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="issues">Issues<a aria-hidden="true" class="hash-link" href="#issues" title="Direct link to heading">â€‹</a></h3><p>The following common issues can occur when using Sections, each issue has an accompanying description and walks you through how to debug them:</p><ul><li><a href="#issue-1-the-state-of-an-entire-section-surface-is-getting-reset">Issue 1: the state of an entire Section surface is getting reset</a>.</li><li><a href="#issue-2-the-section-content-scrolls-away-from-top-after-loading">Issue 2: the Section content scrolls away from top after loading</a>.</li><li><a href="#issue-3-all-items-are-being-re-rendered-after-a-data-update">Issue 3: all items are being re-rendered after a data update</a>.</li><li><a href="#issue-4-the-section-is-not-updating-items-after-a-prop-update">Issue 4: the Section is not updating items after a prop update</a>.</li></ul><p>The code for the above issues is located in the <a href="https://github.com/facebook/litho/tree/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug" target="_blank" rel="noopener noreferrer">changesetdebug</a> file.</p><p>To test yourself: <code>./gradlew installDebug</code> and navigate to the <code>Changeset debug</code> section.</p><h4 class="anchor anchorWithStickyNavbar_31ik" id="issue-1-the-state-of-an-entire-section-surface-is-getting-reset">Issue 1: the state of an entire Section surface is getting reset<a aria-hidden="true" class="hash-link" href="#issue-1-the-state-of-an-entire-section-surface-is-getting-reset" title="Direct link to heading">â€‹</a></h4><p><strong>Code</strong>: <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/StateResettingActivity.java" target="_blank" rel="noopener noreferrer">StateResettingActivity</a></p><p><strong>Scenario</strong>: the surface displays a <code>StateResettingRootComponent</code> which looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnCreateLayout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Component onCreateLayout(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ComponentContext c, @Prop List&lt;DataModel&gt; dataModels, @Prop boolean showHeader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final Component listComponent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RecyclerCollectionComponent.create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .disablePTR(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .section(FavouriteGroupSection.create(new SectionContext(c)).dataModels(dataModels))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .flexGrow(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return showHeader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ? Column.create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .child(Text.create(c).text(&quot;Header&quot;).build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .child(listComponent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      : listComponent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If <code>StateResettingRootComponent</code> can show a header, it creates a Column with a header component and RecyclerCollectionComponent. If the header is not ready yet, it immediately delegates to the RecyclerCollectionComponent. Initially, the header is hidden so <code>StateResettingRootComponent</code> only displays the RecyclerCollectionComponent, but after some time, <code>setRoot</code> is called to indicate to <code>StateResettingRootComponent</code> that the header is ready to display. This will make the header component appear but will cause all items in the <code>RecyclerCollectionComponent</code> to lose any updated state and the entire list will lose its state, such as the current scroll position.</p><p>In a Sections list, when an item in the list loses its state that usually indicates it was treated by the framework as a new item after setting new data. To investigate, refer to the Changeset operations in the Sections Flipper plugin.</p><p>The following video shows that when the second <code>setRoot</code> is triggered, the resulting Changeset for the section contains an <code>INSERT_RANGE</code> operation. Therefore, all items were re-rendered as new items which have just been inserted into the adapter.</p><video width="100%" controls=""><source src="/videos/debugging-sections-issue1.mov"></video><p>The resulting updated list has 20 items, but the Changeset doesnâ€™t have any DELETE operations. This raises the question of what happened to the items that were initially inserted, which indicates that something out of the ordinary is going on with the items the RecyclerBinder knows about. The RecyclerBinder has no knowledge about the items which were inserted on the first render, and that can only mean one thing: a new RecyclerBinder instance was created after the second <code>setRoot</code>. This can happen if the RecyclerCollectionComponentâ€™s state is recreated. You can confirm by adding logging in its <a href="https://github.com/facebook/litho/blob/d23a9406659f27fa9df25d02ae1097a975973bb8/litho-sections-widget/src/main/java/com/facebook/litho/sections/widget/RecyclerCollectionComponentSpec.java#L272" target="_blank" rel="noopener noreferrer"><code>@OnCreateInitialState</code></a> implementation. This means its key is changing after the <code>setRoot</code> update.</p><p>Looking at the implementation of <code>StateResettingRootComponent</code> again, you can see that the <code>RecyclerCollectionComponent</code> can get re-parented depending on the presence of the header, which makes the framework treat it as a different component and reset its key.</p><p>The fix for this issue is to maintain the state after the <code>setRoot</code> update, you need to make the hierarchy of components stable.  This involves making sure that the path from the root to any stateful component is preserved after an update. In this case, always wrapping the children in a column and conditionally adding the header as a child would solve the issue.</p><h4 class="anchor anchorWithStickyNavbar_31ik" id="issue-2-the-section-content-scrolls-away-from-top-after-loading">Issue 2: the Section content scrolls away from top after loading<a aria-hidden="true" class="hash-link" href="#issue-2-the-section-content-scrolls-away-from-top-after-loading" title="Direct link to heading">â€‹</a></h4><p><strong>Code</strong>: <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/ScrollingToBottomActivity.java" target="_blank" rel="noopener noreferrer">ScrollingToBottomActivity</a></p><p><strong>Scenario</strong>: when navigating to this Sections surface, the list is not scrolled to top.  Instead, it scrolls to another item automatically.</p><p>Check the Flipper Sections Plugin to see what happens when navigating to this surface.</p><video width="100%" controls=""><source src="/videos/debugging-sections-issue2.mov"></video><p>In the video above, the initial <code>setRoot</code> call passes to the Section a list of items, starting with item 15. This matches what you see on screen. Later is a <code>setRoot</code> call, which inserts at the top of the Section a list of items from 0 to 14. The order in which this data is inserted explains why the list scrolled to item 15.</p><p>RecyclerView will try to maintain the current scroll position whenever the adapter is notified of changes. In this scenario, the initial scroll position is at item &#x27;15&#x27;, so when the second insert batch is applied, the RecyclerView will keep this as the first visible item, even if items are inserted above.</p><p>This is a commonly occurring scenario that can occur in surfaces that consist of Sections that use different data sources. Imagine a typical feed-like surface that has a header Section followed by the feed stories Section. The two Sections will receive data from different sources, each source being queried independently. This means that the response can return at different times. If the feed stories data is fetched first, these items will be inserted immediately, and the header data will be inserted at the top of the feed items later when the request completes.</p><p>If your Section surface is using data queried from multiple sources, and it can be inserted out of order, you can maintain scroll position at the first item in the list by manually scrolling to the top, after the data reaches the adapter, using the <a href="/docs/communicating-with-the-ui/#scrolling-requestfocus">requestFocus APIs</a>:</p><p>#scrolling-requestfocus</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnDataBound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void onDataBound(SectionContext c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DelayedLoadingSection.requestFocus(c, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_31ik" id="issue-3-all-items-are-being-re-rendered-after-a-data-update">Issue 3: all items are being re-rendered After a data update<a aria-hidden="true" class="hash-link" href="#issue-3-all-items-are-being-re-rendered-after-a-data-update" title="Direct link to heading">â€‹</a></h4><p><strong>Code</strong>: <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/ItemsRerenderingActivity.java" target="_blank" rel="noopener noreferrer">ItemsRerenderingActivity</a></p><p><strong>Scenario</strong>: some items in the Sections list were updated after interacting with them. After some time, the surface appears to blink, and the scroll position is reset. All items are reset, losing any updated state.</p><p>This issue has similar symptoms to <a href="#issue-1-the-state-of-an-entire-section-surface-is-getting-reset">Issue #1</a>, but you can use the Flipper Sections Plugin this time to see whatâ€™s different and how to find the cause.</p><video width="100%" controls=""><source src="/videos/debugging-sections-issue3.mov"></video><p>The list is reset after the second setRoot call is triggered, as can be seen from its generated changesets.</p><p>All the items that were previously in the list were deleted and inserted again, along with the items that are new. This explains the blinking and the state being reset, since all existing items are removed and treated as completely new items.</p><p>The difference between this issue and <a href="#issue-1-the-state-of-an-entire-section-surface-is-getting-reset">issue #1</a> is that the changeset contains a list of delete operations, which means that this is not a case of the RecyclerBinder being reset, but rather something is not working right when comparing the items in the current and new list and deciding if they are the same or not.</p><p>Look at the code for the Section rendering this surface, which you can find in the <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/InefficientFavouriteGroupSectionSpec.java" target="_blank" rel="noopener noreferrer">InefficientFavouriteGroupSectionSpec</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnCreateChildren</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Children onCreateChildren(SectionContext c, @Prop List&lt;DataModel&gt; dataModels) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return Children.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .child(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          DataDiffSection.&lt;DataModel&gt;create(new SectionContext(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .data(dataModels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .renderEventHandler(InefficientFavouriteGroupSection.onRender(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The Section has a DataDiffSection child which is passed a <code>renderEventHandler</code> prop, so it knows how to render the <code>DataModel</code> items but not how to compare them for efficient updates. By default, the Sections framework will compare items first by pointer equality and then by calling <code>equals</code> if no comparison methods are passed to the <code>DataDiffSection</code>. For complex data types, you will always need implement comparison methods to decide when an item should be re-rendered.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnCreateChildren</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Children onCreateChildren(SectionContext c, @Prop List&lt;DataModel&gt; dataModels) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return Children.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .child(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          DataDiffSection.&lt;DataModel&gt;create(new SectionContext(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .data(dataModels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .renderEventHandler(InefficientFavouriteGroupSection.onRender(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .onCheckIsSameItemEventHandler(InefficientFavouriteGroupSection.onCheckIsSameItem(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .onCheckIsSameContentEventHandler(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  InefficientFavouriteGroupSection.onCheckIsSameContent(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(RenderEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static RenderInfo onRender(SectionContext c, @FromEvent DataModel model) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return ComponentRenderInfo.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .component(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Row.create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .child(Text.create(c).text(model.getData()).textSizeDip(30))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .child(RowItem.create(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameItemEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static boolean onCheckIsSameItem(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SectionContext c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @FromEvent DataModel previousItem,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @FromEvent DataModel nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.getId() == nextItem.getId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After making the above change to <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/InefficientFavouriteGroupSectionSpec.java" target="_blank" rel="noopener noreferrer">InefficientFavouriteGroupSectionSpec</a>, only the new item is inserted and all the existing items are reused and their state is persisted, as shown in the following diagram.</p><p><img src="/assets/images/debugging-sections-issue3-d89177f930ae45211cfa8be599805d9a.png"></p><h4 class="anchor anchorWithStickyNavbar_31ik" id="issue-4-the-section-is-not-updating-items-after-a-prop-update">Issue 4: the Section is not updating items after a prop update<a aria-hidden="true" class="hash-link" href="#issue-4-the-section-is-not-updating-items-after-a-prop-update" title="Direct link to heading">â€‹</a></h4><p><strong>Code</strong>: <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/PropUpdatingActivity.java" target="_blank" rel="noopener noreferrer">PropUpdatingActivity</a></p><p><strong>Scenario</strong>: you have a list of items which can be in a selected or unselected state. The Section has a selectedItem prop which is the index of the item which is selected - this value can change based on data coming from an external source. When the value changes, a new prop value is passed to the Section.</p><p>Initially, item at position 0 is selected:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">SelectedItemRootComponent.create(mComponentContext)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .dataModels(mDataModels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .selectedItem(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then after a while, new data is available and item at position 1 needs to be selected:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">SelectedItemRootComponent.create(mComponentContext)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .dataModels(mDataModels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .selectedItem(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>However, it looks like nothing is changing: the item at position 0 is still selected and item at position 1 is still unselected.</p><p>Again, you go to the Flipper Sections Plugin to understand whatâ€™s happening:</p><video width="100%" controls=""><source src="/videos/debugging-sections-issue4.mov"></video><p>Here you see that when you pass a new value for <code>selectedItem</code> and <code>setRoot</code> is called, the changeset generated for this shows us that all items in the list have been reused and nothing got updated. This is not what is expected: items 0 and 1 should be updated.</p><p>As with <a href="#issue-3-all-items-are-being-re-rendered-after-a-data-update">issue #3</a>, this indicates that something is not working right when comparing the items in the current and new list and deciding if they are the same or not. However, looking at <a href="https://github.com/facebook/litho/blob/master/sample/src/main/java/com/facebook/samples/litho/java/changesetdebug/SelectedItemRootComponentSpec.java" target="_blank" rel="noopener noreferrer"><code>SelectedItemRootComponent</code></a>, you see that in this case you are passing comparison methods to the DataDiffSection:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnCreateLayout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Component onCreateLayout(ComponentContext c, @Prop List&lt;DataModel&gt; dataModels) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return RecyclerCollectionComponent.create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .disablePTR(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .section(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          DataDiffSection.&lt;DataModel&gt;create(new SectionContext(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .data(dataModels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .renderEventHandler(SelectedItemRootComponent.onRender(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .onCheckIsSameContentEventHandler(SelectedItemRootComponent.isSameContent(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .onCheckIsSameItemEventHandler(SelectedItemRootComponent.isSameItem(c))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .flexGrow(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(RenderEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static RenderInfo onRender(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ComponentContext c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Prop int selectedItem,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @FromEvent DataModel model,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @FromEvent int index) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return ComponentRenderInfo.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .component(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Row.create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .child(Text.create(c).text(model.getData()).textSizeDip(30))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .child(FixedRowItem.create(c).favourited(selectedItem == index))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameItemEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static boolean isSameItem(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ComponentContext context, @FromEvent DataModel previousItem, @FromEvent DataModel nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.getId() == nextItem.getId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameContentEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static boolean isSameContent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ComponentContext context, @FromEvent DataModel previousItem, @FromEvent DataModel nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.getData().equals(nextItem.getData());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The items in the list would only be changed based on the comparison result. However, when a new value is passed for <code>selectedItem</code>, that prop is only used in the render function and not in the comparison methods.  This means the items being compared will be considered the same even if the selection status changes.</p><p>The fix in this case is to take the <code>selectedItem</code> value into account when doing the comparison. Since you cannot compare previous and current props, change this to make the selection state part of the DataModel class then use that field for comparison instead. After making that change, the new comparison method would look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameContentEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static boolean isSameContent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ComponentContext context, @FromEvent DataModel previousItem, @FromEvent DataModel nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.getData().equals(nextItem.getData())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &amp;&amp; previousItem.isSelected() == nextItem.isSelected();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will correctly take the selection status into account when deciding whether to re-render items or not, and the new changeset will appear as shown in the following diagram.</p><p><img src="/assets/images/debugging-sections-issue4-be3351e85009e3a278b93b12be18615a.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/litho/edit/master/website/../docs/debugging/debugging-sections.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/debugging/debugging-tips/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Debugging Tips</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/devtools/android-studio-plugin/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Android Studio Plugin<!-- --> Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#debugging-litho-sections-surfaces-with-the-flipper-sections-plugin" class="table-of-contents__link toc-highlight">Debugging Litho Sections Surfaces with the Flipper Sections Plugin</a><ul><li><a href="#sections-hierarchies" class="table-of-contents__link toc-highlight">Sections Hierarchies</a></li><li><a href="#sections-terminology" class="table-of-contents__link toc-highlight">Sections Terminology</a></li><li><a href="#issues" class="table-of-contents__link toc-highlight">Issues</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started</a></li><li class="footer__item"><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/contributing/">How To Contribute</a></li><li class="footer__item"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Open Source Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/fblitho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Facebook, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.317d2bec.js"></script>
<script src="/assets/js/main.ddc73d99.js"></script>
</body>
</html>