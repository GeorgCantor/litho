<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-28","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Litho" href="/opensearch.xml"><title data-react-helmet="true">Best Practices and Performance | Litho</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://fblitho.com/docs/sections/best-practices/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Best Practices and Performance | Litho"><meta data-react-helmet="true" name="description" content="When working with Sections, it is not unfrequent to ask yourself whether what you’re doing is performant, efficient, or idiomatic. The API is short and straightforward, which makes you feel like the problems have to be very subtle and hard to find. The reality is much simpler: Sections is built on top of Android’s RecyclerView and inherits all of its properties, which are common knowledge amongst Android developers. You could build your own if you need to, and it won’t be much different from what Sections gives you today."><meta data-react-helmet="true" property="og:description" content="When working with Sections, it is not unfrequent to ask yourself whether what you’re doing is performant, efficient, or idiomatic. The API is short and straightforward, which makes you feel like the problems have to be very subtle and hard to find. The reality is much simpler: Sections is built on top of Android’s RecyclerView and inherits all of its properties, which are common knowledge amongst Android developers. You could build your own if you need to, and it won’t be much different from what Sections gives you today."><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fblitho.com/docs/sections/best-practices/"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/sections/best-practices/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://fblitho.com/docs/sections/best-practices/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.500f1454.css">
<link rel="preload" href="/assets/js/runtime~main.317d2bec.js" as="script">
<link rel="preload" href="/assets/js/main.ddc73d99.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="color:#091E42" role="banner"><div class="announcementBarContent_3EUC">Support Ukraine 🇺🇦 <a target="_blank" rel="noopener noreferrer" href="https://opensource.facebook.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/images/logo.svg" alt="Litho Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Litho</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro/motivation/">Docs</a><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a><a class="navbar__item navbar__link" href="/docs/tutorial/overview/">Tutorial</a><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What is Litho?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Main Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Building lists</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/start/">The Basics: DiffSection and GroupSection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/recycler-collection-component/">Adding and adapting RecyclerCollection to your App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/sections/best-practices/">Best Practices and Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/hscrolls/">Nested scrolling and measurement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/api-overview/">API 📄: annotations, events and lifecycles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/working-ranges/">Advanced: Prefetch and pagination</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/services/">Advanced: Granular Dependency Injection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/view-support/">Advanced: Mixing with Android Views</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/diff-sections/">Advanced: Writing your own DiffSection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sections/architecture/">Internal 🏗: Sections implementation architecture</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Animations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Visibility</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Accessibility</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Widgets</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Adopting Litho</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Codegen APIs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tooling</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_1lV3"><div class="docItemContainer_zt2Y"><article><header><h1 class="docTitle_1y8q">Best Practices and Performance</h1></header><div class="markdown"><p>When working with Sections, it is not unfrequent to ask yourself whether what you’re doing is performant, efficient, or idiomatic. The API is short and straightforward, which makes you feel like the problems have to be very subtle and hard to find. The reality is much simpler: Sections is built on top of Android’s RecyclerView and inherits all of its properties, which are common knowledge amongst Android developers. You could build your own if you need to, and it won’t be much different from what Sections gives you today.</p><p>In this document we’ll introduce the <strong>two key qualities of performance</strong> in Sections: <strong>identity</strong> and <strong>immutability</strong>. These qualities of a data model identity is what is <strong>used by Sections to define whether a section needs to be redrawn</strong>. The more unnecessary redraws, the worse your component will perform. Skipping a redraw for a component that has meaningfully changed is not acceptable.</p><p>Once you read through this document if you feel you need to know <em>more</em> and <em>deeper</em> about RecyclerView, we recommend the original articles on <a href="https://developer.android.com/guide/topics/ui/layout/recyclerview" target="_blank" rel="noopener noreferrer">RecyclerView</a> and <a href="https://developer.android.com/reference/androidx/recyclerview/widget/DiffUtil" target="_blank" rel="noopener noreferrer">DiffUtils</a>, the foundations of Sections. You’ll find they have an extensive API full of flexibility and pitfalls we’ve condensed and simplified for Facebook use cases.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="immutability">Immutability<a aria-hidden="true" class="hash-link" href="#immutability" title="Direct link to heading">​</a></h2><p>Immutability is a quality of a data model, where its values cannot change over time. An example of mutable data is an <code>ArrayList</code>, which can <em>add</em> new elements. An example of immutable data is Java’s <code>String</code>, which cannot be modified in-place, and whose operations always create a new <code>String</code> instance.</p><p>As a performance-oriented person your intuition may be that creating objects incurs on a penalty and mutability is obviously faster. This is certainly true for cases with small locality, such as single-class CPU-bound algorithms. For large-scale cases where concurrency is involved, <strong>the complexity added to prevent data races and other nasty behaviours heavily offsets the cost of a few additional allocations per second</strong>.</p><p>So, what can we do to minimise the number of additional allocations of immutable data models? Never request them if they’re not necessary! To do this <strong>on Sections we visit your data model to find the smallest granularity we have to request a redraw for</strong>. This is done using the data model’s identity.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="identity">Identity<a aria-hidden="true" class="hash-link" href="#identity" title="Direct link to heading">​</a></h2><p>Identity is another quality of a data model that defines <strong>whether it is equal to another data model</strong>, or even itself. <strong>The action of comparing two data models to find the most granular differences is referred as diffing</strong>.</p><p>What the equality is for a data model is to be defined by its creator. It can be defined by its reference in memory (<em>referencial equality</em>), the hash of its contents (<em>hash equality</em>), the value of a field such as id (<em>identifier equality</em>), or even delegate to the equality of each of its fields (<em>structural equality</em>).</p><p>Let’s see one example, <code>User</code>, which has a list of <code>Friend</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">typealias User = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user: FbId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  friends: Array&lt;Friend&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typealias Friend = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id: FbId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">User user1 = new User(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user= &quot;1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  friends= [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new Friend(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name= &quot;kata&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id= &quot;333&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User user2 = new User(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user= &quot;1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  friends= [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new Friend(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name= &quot;kata&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id= &quot;333&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We could define the identity of <code>User</code> as its <em>reference</em>, which implies:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">user1 == user1 // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1 == user2 // false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Or we could define it as the <em>structure</em> or <em>hash</em> of its contents, which becomes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">user1.hashCode() == user1.hashCode() // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1.hashCode() == user2.hashCode() // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1.equals(user1)                  // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1.equals(user2)                  // true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Or we could just use the <code>user</code> <em>identifier</em> as the identity:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">User user3 = new User(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user= &quot;1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  friends= []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">user1.user == user1.user // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1.user == user2.user // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user1.user == user3.user // true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So, choosing the right identity for your data model is key for performance.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Notice that these go from more strict to less strict: reference, structure and hash, then identifier.</p></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Java classes use the <code>equals</code> function to define their identity, and the default implementation delegates to referential equality. Do remember to <code>@Override</code> it accordingly.</p></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="singlecomponentsection-diffing">SingleComponentSection Diffing<a aria-hidden="true" class="hash-link" href="#singlecomponentsection-diffing" title="Direct link to heading">​</a></h2><p>SingleComponentSection is built as a thin wrapper, so it follows the Component rules for identity. <strong>If a wrapped Component has not significantly changed it won’t trigger a redraw</strong>.</p><p>The diffing algorithm for Components starts by checking the <em>referential equality</em> of the component with <code>==</code>, then it traverses its Props and checks their <em>structural equality</em> with <code>equals</code>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="datadiffsection-diffing">DataDiffSection Diffing<a aria-hidden="true" class="hash-link" href="#datadiffsection-diffing" title="Direct link to heading">​</a></h2><p>The main API of Sections is a wrapper around Android’s <code>RecyclerView</code> operations, calling notifications for updates, insertions and removals behind the scenes. It takes a <code>List</code> of elements and uses a <strong>traversal algorithm that takes into account all the kinds of identity equality listed above by using <code>==</code>, <code>equals</code> and user defined Events</strong>.</p><p>First it checks whether it needs to do a granular identity check on the data model, and if the check passes it visits the contents of the data model.</p><p>The check for granularity does <em>referential equality</em> with <code>==</code>, then checks <em>identifier equality</em> using the event <code>OnCheckIsSameItemEvent</code>, and lastly it falls back to <em>structural equality</em> with <code>equals</code>. Remember that Java’s <code>equals</code> defaults to referential equality. If any of them passes, it goes one level further to check for equality on its contents using the event <code>OnCheckIsSameContentEvent</code>.</p><p>These two new events <code>OnCheckIsSameItemEvent</code> and <code>OnCheckIsSameContentEvent</code> exist for the benefit of data models where it’s not possible to override <em>equals</em> directly, i.e. using GraphQL-generated models directly.</p><p>Their API is similar to other Litho Events, where a function needs to be annotated as the listener in the ComponentSpec. The model to compare has to be annotated with <code>@FromEvent</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameItemEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected static Boolean onCheckIsSameItemEvent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SectionContext c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @InjectProp SomeHelper helper,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @FromEvent BookmarkFolderItemComponentGraphQL previousItem,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @FromEvent BookmarkFolderItemComponentGraphQL nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.id == nextItem.id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnEvent(OnCheckIsSameContentEvent.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected static boolean onCheckIsSameContent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SectionContext c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @InjectProp SomeHelper helper,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @FromEvent BookmarkFolderItemComponentGraphQL previousItem,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @FromEvent BookmarkFolderItemComponentGraphQL nextItem) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return previousItem.bookmark.equals(nextItem.bookmark);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This means that we’ve made the algorithm check if two <code>BookmarkFolderItemComponentGraphQL</code> have the same <em>reference</em> with <code>==</code>, then if they have the same <code>id</code> <em>identifier</em>, and lastly if they match their <em>structure</em> with <code>equals</code>. If either of these checks pass, then we dig deeper to compare the <em>structure</em> of their bookmark field.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="avoiding-indexoutofboundsexception">Avoiding <code>IndexOutOfBoundsException</code><a aria-hidden="true" class="hash-link" href="#avoiding-indexoutofboundsexception" title="Direct link to heading">​</a></h3><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>If you find yourself encountering occassional <code>IndexOutOfBoundsException</code> coming from <code>RecyclerBinder</code>, it most likely indicates that invalid diffs are being generated by <code>DiffUtils</code>.</p></div></div><p>There are two main causes for invalid diffs:</p><ol><li><strong>Duplicates</strong>: According to your <code>@OnCheckIsSameItem</code>, two different items in your list are considered the same item. <code>DiffUtils</code> doesn&#x27;t correctly detect this and will generate an invalid diff. To fix this, ensure that no two different items in the list can ever be considered the same. To test if this is happening, you can also temporarily enable <code>alwaysDetectDuplicates</code> on your <code>DataDiffSection</code>: this turns on pairwise duplicate checking that will raise errors through <code>ComponentsReporter</code>.</li><li><strong>Mutable Data</strong>: Because Sections diffing can occur on a background thread, mutations to the list or its elements from another thread can cause DiffUtils to emit an invalid diff. The reason for this is that <code>@OnCheckIsSameItem</code> and/or <code>@OnCheckIsSameContent</code> may return inconsistent results for the same pairs of indices over the course of diffing the lists. The easiest way to fix this is to use immutable lists and immutable data with DataDiffSection and the Sections API.</li></ol><h2 class="anchor anchorWithStickyNavbar_31ik" id="usage-pitfalls-to-avoid">Usage pitfalls to avoid<a aria-hidden="true" class="hash-link" href="#usage-pitfalls-to-avoid" title="Direct link to heading">​</a></h2><p>With this knowledge in mind, we can talk about tips and pitfalls to take into account to prevent over- and under- redraws.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="keep-component-and-section-keys-stable">Keep Component and Section keys stable<a aria-hidden="true" class="hash-link" href="#keep-component-and-section-keys-stable" title="Direct link to heading">​</a></h3><p>Same as with any other Component, Sections have a key that can be overloaded to the user’s benefit. <strong>If the key is unstable, meaning that it changes at a different frequency than its contents, it will result in overdraws</strong>. Double check both for the Section and the RecyclerCollectionComponent.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="it-is-still-just-a-fancy-recyclerview-adapter">It is still just a fancy RecyclerView adapter<a aria-hidden="true" class="hash-link" href="#it-is-still-just-a-fancy-recyclerview-adapter" title="Direct link to heading">​</a></h3><p>Any bugs or unexpected behaviours inherited from the Android implementation remain. <strong>It is not uncommon to encounter a known issue, so be sure to also search the Android bugtracker</strong>.</p><p>One frequent support request asks <strong>why adding elements before the first element doesn’t scroll the view to the top on the first redraw?</strong> This is an inherited behaviour that is easily solved by <code>requestFocus</code> to scroll to the current top position.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="sections-may-have-different-contexts-than-their-components">Sections may have different contexts than their Components<a aria-hidden="true" class="hash-link" href="#sections-may-have-different-contexts-than-their-components" title="Direct link to heading">​</a></h3><p>This happens frequently when <strong>events are not triggered</strong> when the caller and the listener are on different <code>ComponentContext</code>. Check that your container <code>ComponentTree</code> and the Components you&#x27;re displaying belong in the same context.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="usage-tips-to-follow">Usage tips to follow<a aria-hidden="true" class="hash-link" href="#usage-tips-to-follow" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="triggering-partial-redraws-from-outside-the-sections-component">Triggering partial redraws from outside the Sections Component<a aria-hidden="true" class="hash-link" href="#triggering-partial-redraws-from-outside-the-sections-component" title="Direct link to heading">​</a></h3><p>We will use the example of a <code>RecyclerCollectionComponent</code> that is acted externally, by selecting and highlighting a bookmark after it has been added from a post in another Component.</p><p>The best approach here is to rely on <code>DataDiffSection</code> diffing to modify the right row. That will mean either <strong>modifying or wrapping the current data model to include a new property</strong> of whether it’s highlighted.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class BookmarkFolderItemComponentHighlight {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int highlightColor = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool isHighlight = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BookmarkFolderItemComponentGraphQL model;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // equals and hashCode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>These additional object allocations are cheaper than a full redrawn for single-row changes.</p></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="triggering-full-redraws-from-outside-the-sections-component">Triggering full redraws from outside the Sections Component<a aria-hidden="true" class="hash-link" href="#triggering-full-redraws-from-outside-the-sections-component" title="Direct link to heading">​</a></h3><p>We will use the example of a “Night Mode“ for your <code>RecyclerCollection</code>. You’d like for the background to change between both day and night modes when a button that’s not part of the <code>RecyclerCollection</code> is clicked.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>This approach causes the list to lose its State. Prefer partial redraws wherever possible.</p></div></div><p>The easiest way of triggering a redraw from scratch is by <strong>making the color state part of the Section key</strong>. When your Component triggers the event and the algorithm traverses the view, <strong>it’ll see that the key has change and trigger a full redraw of the relevant Section</strong>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@OnCreateChildren</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Children onCreateChildren(final SectionContext c, @Prop int color) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return Children.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .child(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          DataDiffSection.&lt;Integer&gt;create(c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .key(&quot;my_section_&quot; + color)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .data(generateData(32))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .renderEventHandler(ListSection.onRender(c)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/litho/edit/master/website/../docs/sections/best-practices.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/sections/recycler-collection-component/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Adding and adapting RecyclerCollection to your App</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/sections/hscrolls/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Nested scrolling and measurement<!-- --> »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#immutability" class="table-of-contents__link toc-highlight">Immutability</a></li><li><a href="#identity" class="table-of-contents__link toc-highlight">Identity</a></li><li><a href="#singlecomponentsection-diffing" class="table-of-contents__link toc-highlight">SingleComponentSection Diffing</a></li><li><a href="#datadiffsection-diffing" class="table-of-contents__link toc-highlight">DataDiffSection Diffing</a><ul><li><a href="#avoiding-indexoutofboundsexception" class="table-of-contents__link toc-highlight">Avoiding <code>IndexOutOfBoundsException</code></a></li></ul></li><li><a href="#usage-pitfalls-to-avoid" class="table-of-contents__link toc-highlight">Usage pitfalls to avoid</a><ul><li><a href="#keep-component-and-section-keys-stable" class="table-of-contents__link toc-highlight">Keep Component and Section keys stable</a></li><li><a href="#it-is-still-just-a-fancy-recyclerview-adapter" class="table-of-contents__link toc-highlight">It is still just a fancy RecyclerView adapter</a></li><li><a href="#sections-may-have-different-contexts-than-their-components" class="table-of-contents__link toc-highlight">Sections may have different contexts than their Components</a></li></ul></li><li><a href="#usage-tips-to-follow" class="table-of-contents__link toc-highlight">Usage tips to follow</a><ul><li><a href="#triggering-partial-redraws-from-outside-the-sections-component" class="table-of-contents__link toc-highlight">Triggering partial redraws from outside the Sections Component</a></li><li><a href="#triggering-full-redraws-from-outside-the-sections-component" class="table-of-contents__link toc-highlight">Triggering full redraws from outside the Sections Component</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started</a></li><li class="footer__item"><a href="/javadoc" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/contributing/">How To Contribute</a></li><li class="footer__item"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Open Source Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/litho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/fblitho" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/images/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2022 Facebook, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.317d2bec.js"></script>
<script src="/assets/js/main.ddc73d99.js"></script>
</body>
</html>